name: üöÄ i9 Tech CI/CD - Deploy para AWS EC2

on:
  workflow_call:
  push:
    branches: [feature/aws]  

jobs:
  deploy:
    name: Deploy Container to EC2 via SSH
    runs-on: ubuntu-latest

    steps:
      - name: üîÅ Checkout do reposit√≥rio
        uses: actions/checkout@v4

      # 1) Limpar e preparar pasta na EC2
      - name: üßπ Limpar e preparar pasta na EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="/home/${{ secrets.REMOTE_USER }}/i9-application"

            rm -rf "$DEPLOY_DIR"
            mkdir -p "$DEPLOY_DIR/nginx"
            echo "Pasta limpa e preparada em $DEPLOY_DIR"

      # 2) Copiar docker-compose.yml
      - name: üì¶ Copiar docker-compose.yml para EC2
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: /home/${{ secrets.REMOTE_USER }}/i9-application/
          SOURCE: "docker-compose.yml"
          ARGS: "-rltgoDzvO"

      # 3) Copiar pasta nginx
      - name: üì¶ Copiar pasta nginx para EC2
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: /home/${{ secrets.REMOTE_USER }}/i9-application/
          SOURCE: "nginx"
          ARGS: "-rltgoDzvO"

      # 4) Executar deploy remoto com substitui√ß√£o REAL de vari√°veis
      - name: üöÄ Executar deploy na EC2 (docker compose)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            DEPLOY_DIR="/home/${{ secrets.REMOTE_USER }}/i9-application"
            cd "$DEPLOY_DIR"

            export DOCKER_IMAGE_FULL_PATH="${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_IMAGE_NAME }}:latest"
            export IP_REMOTE_PRIVADO="${{ secrets.REMOTE_HOST_PRIVADO }}"

            echo "üîß Substituindo vari√°veis no nginx/app.conf..."
            envsubst '$IP_REMOTE_PRIVADO' < nginx/app.conf.template > nginx/app.conf

            echo "üîß Substituindo vari√°veis no docker-compose.yml..."
            envsubst '$DOCKER_IMAGE_FULL_PATH' < docker-compose.yml > docker-compose.resolved.yml
            mv docker-compose.resolved.yml docker-compose.yml

            echo "üîê Fazendo login no Docker Hub..."
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | sudo docker login \
              ${{ secrets.DOCKER_REGISTRY }} \
              -u ${{ secrets.DOCKER_USERNAME }} \
              --password-stdin

            # Usar docker compose se existir, sen√£o docker-compose
            if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            else
              DOCKER_COMPOSE_CMD="docker-compose"
            fi

            echo "üì¶ Fazendo pull da imagem..."
            sudo $DOCKER_COMPOSE_CMD pull

            echo "üõë Derrubando containers antigos..."
            sudo $DOCKER_COMPOSE_CMD down -v --remove-orphans || true

            echo "üöÄ Subindo nova vers√£o..."
            sudo $DOCKER_COMPOSE_CMD up -d --force-recreate --remove-orphans

            echo "üéâ Deploy finalizado com sucesso!"
