name: üöÄ Deploy App Frontend to AWS EC2 (PULL Docker Image)

on:
  push:
    branches:
      - feature/aws # Confirme se √© a branch correta

jobs:
  deploy:
    name: Deploy Container to EC2 via SSH
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do c√≥digo
      - name: üîÅ Checkout do Reposit√≥rio
        uses: actions/checkout@v4

      # 2. NOVO PASSO: Garante que as pastas existem na EC2
      - name: üõ†Ô∏è Preparar Ambiente na EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Remove arquivo (se for o caso) e cria a pasta base
            if [ -f "/home/${{ secrets.REMOTE_USER }}/i9-application" ]; then
              rm "/home/${{ secrets.REMOTE_USER }}/i9-application"
            fi
            
            # Cria a estrutura de pastas
            mkdir -p /home/${{ secrets.REMOTE_USER }}/i9-application/nginx
            echo "Diret√≥rios de deploy garantidos."


      # 3. Copiar o arquivo docker-compose.yml (AGORA COM A TAG 'image:')
      - name: üì¶ Copiar docker-compose.yml
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: /home/${{ secrets.REMOTE_USER }}/i9-application/
          SOURCE: "docker-compose.yml"
          ARGS: "-rltgoDzvO"

      # 4. Copiar a pasta nginx (TARGET corrigido)
      - name: üì¶ Copiar Pasta de Configura√ß√£o Nginx
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          # TARGET: o caminho da pasta PAI
          TARGET: /home/${{ secrets.REMOTE_USER }}/i9-application/
          SOURCE: "nginx"
          ARGS: "-rltgoDzvO"
          
      # 5. SSH e Deploy no EC2
      - name: üöÄ Executar Deploy Docker Compose na EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          
          script: |
            set -e
            
            # Vari√°veis para a configura√ß√£o do Nginx (IP)
            export IP_REMOTE_PRIVADO=${{ secrets.REMOTE_HOST_PRIVADO }}
            
            # Vari√°vel para o caminho completo da imagem
            export DOCKER_IMAGE_FULL_PATH=${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_IMAGE_NAME }}:latest
            echo "Caminho da imagem Docker definido como: $DOCKER_IMAGE_FULL_PATH"
            
            cd /home/${{ secrets.REMOTE_USER }}/i9-application
            
            # 1. GERA o app.conf FINAL
            envsubst '$IP_REMOTE_PRIVADO' < nginx/app.conf.template > nginx/app.conf
            echo "Arquivo nginx/app.conf atualizado com IP privado."
            
            # 2. Login
            echo "${{ secrets.DOCKER_HUB_TOKEN}}" | sudo docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            echo "Login Succeeded"
            
            # 3. Puxa a imagem
            sudo DOCKER_IMAGE_FULL_PATH="${DOCKER_IMAGE_FULL_PATH}" docker-compose pull
            
            # Remove o container antigo for√ßadamente para evitar erro do docker-compose v1
            sudo docker rm -f i9-website-application || true

            # 4. Sobe o servi√ßo
            sudo DOCKER_IMAGE_FULL_PATH="${DOCKER_IMAGE_FULL_PATH}" docker-compose up -d --force-recreate nginx 
            
            echo "Deploy finalizado com sucesso!"