name: üöÄ Deploy App Frontend to AWS EC2 (PULL Docker Image)

on:
  push:
    branches:
      - feature/aws

jobs:
  deploy:
    name: Deploy Container to EC2 via SSH
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do c√≥digo
      - name: üîÅ Checkout do Reposit√≥rio
        uses: actions/checkout@v4

      # 2. Copiar o arquivo docker-compose.yml
      # Adicionamos o passo no target para n√£o dar erro
      - name: üì¶ Copiar docker-compose.yml
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: /home/${{ secrets.REMOTE_USER }}/i9-application 
          SOURCE: "docker-compose.yml"
          ARGS: "-rltgoDzvO"

      # 3. Copiar a pasta nginx/app.conf.template e outros
      - name: üì¶ Copiar Pasta de Configura√ß√£o Nginx
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: /home/${{ secrets.REMOTE_USER }}/i9-application/nginx
          SOURCE: "nginx/" # Copia o conte√∫do da pasta nginx, incluindo o .template
          ARGS: "-rltgoDzvO --delete"
          
      # 4. SSH e Deploy no EC2 (PULL da imagem e UP do Compose)
      - name: üöÄ Executar Deploy Docker Compose na EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          
          # Script de deploy
          script: |
            set -e
            
            # Define a vari√°vel com o IP privado do Backend 
            export IP_REMOTE_PRIVADO=${{ secrets.REMOTE_HOST_PRIVADO }}
            echo "Vari√°vel de IP privado criada: $IP_REMOTE_PRIVADO"

            # Navegar at√© o diret√≥rio da aplica√ß√£o no EC2
            cd /home/${{ secrets.REMOTE_USER }}/i9-application
            
            # L√™ o template, substitui $IP_REMOTE_PRIVADO pelo valor real, e salva como app.conf
            envsubst '$IP_REMOTE_PRIVADO' < nginx/app.conf.template > nginx/app.conf
            echo "Arquivo nginx/app.conf atualizado com IP privado."
            
            # Login no Registry (necess√°rio para puxar a imagem privada)
            echo "${{ secrets.DOCKER_HUB_TOKEN}}" | docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            echo "Login no Docker Registry conclu√≠do."

            # Puxar a imagem mais recente (se o nome da imagem estiver definido no compose)
            docker-compose pull
            echo "Imagens atualizadas puxadas."

            # Reiniciar o servi√ßo do Nginx (frontend)
            docker-compose up -d --force-recreate i9-website-application 
            echo "Servi√ßo frontend reiniciado com sucesso."