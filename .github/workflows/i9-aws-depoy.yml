name: üöÄ i9 Tech CI/CD - Build Local e Deploy na EC2

on:
  push:
    branches:
      - feature/aws

jobs:
  build_and_deploy:
    name: Build React & Docker Deploy Local
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do c√≥digo
      - name: üîÅ Checkout do reposit√≥rio
        uses: actions/checkout@v4

      # 2. Setup do Node e Build do React (Gera a pasta dist)
      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Instalar Depend√™ncias e Build
        run: |
          npm ci
          npm run build
        working-directory: . 

      # 3. Limpeza e Prepara√ß√£o na EC2
      - name: üßπ Limpar pasta remota
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Define o diret√≥rio de destino
            DEPLOY_DIR="/home/${{ secrets.REMOTE_USER }}/i9-application"
            
            # Remove a vers√£o anterior para garantir que n√£o haja arquivos velhos
            rm -rf "$DEPLOY_DIR"
            mkdir -p "$DEPLOY_DIR"
            echo "Diret√≥rio $DEPLOY_DIR limpo e recriado."

      # 4. Transfer√™ncia de Arquivos (Build + Configs + Dockerfile)
      - name: üìÇ Copiar arquivos para EC2
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: /home/${{ secrets.REMOTE_USER }}/i9-application
          SOURCE: "dist/ nginx/ Dockerfile"
          ARGS: "-rltgoDzvO"

      # 5. Execu√ß√£o Remota: Configura√ß√£o, Docker Build e Run
      - name: üöÄ Build da Imagem e Start do Container na EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="/home/${{ secrets.REMOTE_USER }}/i9-application"
            cd "$DEPLOY_DIR"

            echo "--- Configurando Vari√°veis de Ambiente ---"
            export IP_REMOTE_PRIVADO="${{ secrets.REMOTE_HOST_PRIVADO }}"
            
            if [ -f "nginx/app.conf.template" ]; then
              envsubst '$IP_REMOTE_PRIVADO' < nginx/app.conf.template > nginx/app.conf
              echo "Arquivo nginx/app.conf gerado com sucesso."
            fi

            echo "--- Gerenciando Containers Antigos ---"
            docker stop i9-website-container || true
            docker rm i9-website-container || true

            echo "--- Iniciando Build Local da Imagem Docker ---"
            docker build -t i9-website-image .

            echo "--- Subindo Novo Container ---"
            docker run -d \
              --name i9-website-container \
              --network host \
              --restart always \
              i9-website-image

            echo "‚úÖ Deploy finalizado com sucesso!"